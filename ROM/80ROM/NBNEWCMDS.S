;Newbrain new commands

                GLOBAL PATCHCMDS

		;NBROM FUNCTION & VARS
		ZCM2HL EQU $01D7
		WEXPN EQU $18DF
		PSCAN EQU $A2D4;
		TPLOT EQU $A35A
		ZCMONE EQU $57D7 
		XTABLE EQU $DD14
		XTABL2 EQU $DE00
		XTABL3 EQU $A443
		LPCODE EQU $56
		ENTER EQU $C335
		WCM2HL EQU $01DF
		WFORMAT EQU $47DF
		WCHKOPN EQU $44DF
	
		ZPTMSG	EQU $39D7
  		ZRDLN2 EQU $4FD7
		TEXT EQU $A334
		GUSTP EQU $DC36
		LDUSTP EQU $C58C

;NOT NEEDED
		GFORP EQU $D1A0
		ZRDLN2 EQU $4FD7
		OUTCON EQU 6
		ZBLKOUT EQU $3DE7


		
		;everything is in RAM, FPGA controls write signal
PATCHCMDS:	LD A,11b		;DISABLE INTS & DISABLE NB=RAM WRITABLE
		OUT (INTENB),A
		LD HL,$A2F9
		LD (HL),$CD ;CALL
		LD DE,CHKNEWCMD
		INC HL
		LD (HL),E
		INC HL
		LD (HL),D
		LD HL,$A485		;PXCL3
		LD (HL),$C3 ;JP
		LD DE,OSXCL3
		INC HL
		LD (HL),E
		INC HL
		LD (HL),D
		LD A,01b		;DISABLE INTS & ENABLE NB=RAM NON WRITABLE
		OUT (INTENB),A		
		RET


		;new command
		TOS DEFB 1
		DEFM 'O'
		DEFB 'S'+80H


OSXCL3:		LD BC,XTABLE
		JP M,ENTER
		LD BC,XTABL2
		CP LPCODE
		JP C,ENTER       ;IF <$56 GOTO TAB2 
		LD BC,XTABL3
		CP OSCODE
		JP C,ENTER	;IF <$62 GOTO TAB3
		LD BC,XTABL4	;ELSE  OUR TAB4
		JP ENTER

CHKNEWCMD:	;PUSH AF
		PUSH IX
		PUSH IY
		PUSH DE
		LD HL,TOS
		CALL PSCAN
		CALL NC, COSCMD
		POP DE
		POP IY
		POP IX
		;POP AF
		LD HL,TPLOT
		RET

;COMPILE OS CMD
COSCMD:		LD HL,OSLST
		CALL PSCAN	;check for any of the OS COMMAND-list
		RET C
		LD H,C		;THE OS LIST COMMAND ID ON C
		LD L,YOSCMD	;THE OS COMMAND
		DEFW ZCM2HL
		DEC B		;CHECK FOR ARGS
		RET Z
		;HERE IF COMMAND HAS A PARAM
		;CURRENTLY ONLY CD HAS A TEXT PARAM
		;ELSE CHECK C TO SEE WHICH COMMAND
		DEFW WEXPN
		RET C
		; LD A,5
		; DEFW ZCMONE
		; DEFW WFORMAT
		; LD H,B
		; LD L,C
		; DEFW WCM2HL			

		RET
		

OSCMDTBL:	DEFW CMD_DIR
		DEFW CMD_CD

CDIR	EQU 0
CCD	EQU 1



OSCODE  EQU (0B1H.SHL.1).AND.0FFH 
XTABL4	EQU $-OSCODE
; X table for  10XXXXXX type OP codes
XBASEN4 EQU XTABL4-100H ;so Ycode is table displ. +80H
 
YOSCMD  EQU ($-XBASEN4)/2        
        DEFW XOSCMD

XOSCMD:	LD A,(HL)	;GET SUB COMMAND 0=DIR 1=CD
	OR A
	JR Z,CMD_DIR
	DEC A
	JR Z,CMD_CD
	;SHOULD NOT HAVE COME HERE
	RET

OSLST:	DEFB 2	;no of sub-commands
 
	DEFM 'DI'		
	DEFB 'R'+80H,CDIR,1  ;+1 OF ARGS
 
	DEFM 'C'		
	DEFB 'D'+80H,CCD,2



CMD_DIR:	DEFW ZPTMSG	;
		DEFB 17
		DEFB $0D
		DEFM "---[DIR INFO]--"
		DEFB $0D
		CALL STRG_DIRLIST		;PRINT DIR
		RET
	
CMD_CD:		CALL GUSTP			;SETS HL FROM IX+11,12 USRTOP
		CALL STRG_DIRCHG
		JR C, CD_ERR
		LD A,150			;ERROR MISSING FILE
		JR Z,CD_ERR
		;OPEN OK ADD TO DIRNM
		;PUSH HL
		;DEFW ZPTMSG	;
		;DEFB 6
		;DEFM "DIR OK"
		;POP HL
		CALL STRG_DIRNMCHG
		JR CD_CONT
CD_ERR:		;ERROR ON OPEN DIR		
		PUSH HL
		PUSH AF		
		DEFW ZPTMSG	;
		DEFB 5
		DEFM "ERR_R"
		POP AF		
		CALL SOUTAS		
		POP HL		
CD_CONT:	PUSH AF				;SAVE FLAGS		
		;FIND ZT ADD 4 AND SAVE TO USER TOP
		LD D,H
		LD E,L
CD_AGN:		LD A,(DE)
		CP 0
		LD A,0
		LD (DE),A  		;ZERO THIS
		INC DE
		JR NZ,CD_AGN
		LD B,4
CD_AGN2: 	LD (DE),A
		INC DE
		DJNZ CD_AGN2
		;PRINT CURRENT DIR
		PUSH HL
		PUSH DE
		LD HL,DIRNM
NXTCHR:		LD A,(HL)
		OR A 
		JR Z,NXTPATH
		DEFW WPTCHAR
		INC HL
		JR NXTCHR
NXTPATH:	INC HL
		LD A,(HL)
		OR A
		JR NZ,NXTCHR
		POP DE
		POP HL
		EX DE,HL
		CALL LDUSTP
				;FIND A WAY TO CLEAN OUR GARBAGE
		;CF MEANS ERROR
				
		POP AF		;REST FLAGS		
		XOR A
		RET