ORG $4000


INCLUDE BOOTLD_8000.SYM

		

		CALL PS2KBINIT

TSTKB:		CALL PS2KEYAVAIL
		JR NZ,TSTKB				
		CALL READCHAR2		;GET THE KEY FROM USB KEYBOARD (HAS A TIMEOUT)
		OR A
		JR Z,TSTKB				
		PUSH AF
		CALL RS_TX
		LD A,32
		CALL RS_TX
		POP AF				
		CALL SOUTAS
		LD A,(LASTKEY)
		CALL SOUTAS
		LD A,(KEYCTR)
		CALL SOUTAS
		LD A,32
		CALL RS_TX
		LD A,13
		CALL RS_TX
		;LD A,10
		;CALL RS_TX

		;LD BC, FFFFh
		;CALL $9CA3		;pAUSE DELAY
		JR TSTKB


PS2KBINIT:	LD HL,KEYCTR
		LD (HL),0
		RET

;ZF SET MEANS KEY IS AVAILABLE
PS2KEYAVAIL:	IN A,(6)
		CP 56  ;38H =0011 1000  0011 IS 3 MEANS KBD INPUT 1000 MEANS REAL KEYBOARD
		RET



READCHAR2:	CALL GETKEY2		;GET HARDWARE KEY WITH CHECKS ON SHIFT...
		OR A	;
		RET Z
		LD (LASTKEY),A
		CALL PS2LOK
		RET

;RETURNS THE KEY CODE PRESSED ALSO CHECKS THE EXTENDED KEYS AND SETS SHIFT CONTROL ETC
GETKEY2:	CALL NGETKEY2		;GET SCANCODE FROM PS/2 KEYB
		OR A	
		RET Z			;IF KEYBRD KEY IS ZERO
		CALL $9805		;CHECKEXT SHIFTS CTRL ALT CAPS
		RET


NGETKEY2:	DI
		IN A,(DEVKBI)		
		LD C,A
		CALL KBENABLE
		LD A,C
		EI
		LD HL,KBDFLAG		;$E4
		LD (HL),0
		RET

KBDISABLE:	LD A, 2
		OUT (DEVKBI), A
		RET
		
KBENABLE:	XOR A
		OUT (DEVKBI), A
		OUT (DEVKBI), A
		OUT (DEVKBI), A
		RET



